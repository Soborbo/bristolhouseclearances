---
import Container from '../ui/Container.astro';

const phoneNumber = '0117 123 4567';
const phoneHref = 'tel:+44117123456';
const email = 'info@bristolhouseclearances.co.uk';
const whatsappHref = 'https://wa.me/44117123456?text=Hi%2C%20I%20need%20a%20clearance%20quote.%20Here%20are%20photos%20of%20what%20needs%20clearing%3A';
---

<section id="contact" class="py-16 lg:py-20 bg-brand-green">
  <Container>
    <div class="text-center mb-10">
      <h2 class="text-3xl sm:text-4xl font-bold text-white tracking-tight">
        Ready to Get Cleared? Let's Go.
      </h2>
      <p class="mt-3 text-lg text-green-100 max-w-xl mx-auto">
        Get your free, no-obligation quote in minutes. We respond within 2 hours.
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 max-w-5xl mx-auto">
      <!-- Contact form -->
      <div class="bg-white rounded-2xl p-6 sm:p-8 shadow-lg">
        <h3 class="font-bold text-lg text-brand-navy mb-4">Send us a message</h3>
        <form id="contact-form" class="space-y-4" novalidate>
          <div>
            <label for="contact-name" class="block text-sm font-medium text-slate-700 mb-1">Name</label>
            <input id="contact-name" type="text" name="name" required maxlength="200" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-green focus:border-brand-green outline-none transition" />
          </div>
          <div>
            <label for="contact-phone" class="block text-sm font-medium text-slate-700 mb-1">Phone</label>
            <input id="contact-phone" type="tel" name="phone" required maxlength="20" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-green focus:border-brand-green outline-none transition" />
          </div>
          <div>
            <label for="contact-email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
            <input id="contact-email" type="email" name="email" required maxlength="254" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-green focus:border-brand-green outline-none transition" />
          </div>
          <div>
            <label for="contact-postcode" class="block text-sm font-medium text-slate-700 mb-1">Postcode</label>
            <input id="contact-postcode" type="text" name="postcode" maxlength="10" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-green focus:border-brand-green outline-none transition" placeholder="BS1 1AA" />
          </div>
          <div>
            <label for="contact-message" class="block text-sm font-medium text-slate-700 mb-1">Tell us about the job</label>
            <textarea id="contact-message" name="message" rows="3" maxlength="2000" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-green focus:border-brand-green outline-none transition resize-none"></textarea>
          </div>
          <label class="flex items-start gap-2 cursor-pointer">
            <input type="checkbox" name="gdpr" required class="mt-0.5 w-4 h-4 rounded border-slate-300 text-brand-green focus:ring-brand-green" />
            <span class="text-xs text-slate-500">I agree to be contacted about my enquiry. We'll never share your details.</span>
          </label>
          <!-- Honeypot -->
          <div class="hidden" aria-hidden="true">
            <input type="text" name="website" tabindex="-1" autocomplete="off" />
          </div>
          <button type="submit" class="w-full py-3 bg-brand-green hover:bg-brand-green-dark text-white font-semibold rounded-lg transition-colors">
            Get My Free Quote
          </button>
          <div id="contact-error" class="hidden text-center text-sm text-red-600 font-medium" role="alert"></div>
        </form>
        <div id="contact-success" class="hidden text-center py-8" role="status">
          <div class="text-3xl mb-3" aria-hidden="true">&#x2705;</div>
          <h4 class="font-bold text-lg text-brand-navy">Message sent!</h4>
          <p class="text-slate-500 text-sm mt-1">We'll be in touch within 2 hours.</p>
        </div>
      </div>

      <!-- Contact methods -->
      <div class="flex flex-col justify-center space-y-6 text-white">
        <a href={phoneHref} class="flex items-center gap-4 group">
          <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center group-hover:bg-white/30 transition-colors">
            <svg class="w-6 h-6" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" /></svg>
          </div>
          <div>
            <p class="font-bold text-xl">{phoneNumber}</p>
            <p class="text-green-100 text-sm">Call us directly</p>
          </div>
        </a>

        <a href={whatsappHref} target="_blank" rel="noopener" class="flex items-center gap-4 group">
          <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center group-hover:bg-white/30 transition-colors">
            <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
          </div>
          <div>
            <p class="font-bold text-lg">WhatsApp Us Photos</p>
            <p class="text-green-100 text-sm">Get a firm quote in minutes</p>
          </div>
        </a>

        <a href={`mailto:${email}`} class="flex items-center gap-4 group">
          <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center group-hover:bg-white/30 transition-colors">
            <svg class="w-6 h-6" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" /></svg>
          </div>
          <div>
            <p class="font-bold text-lg">{email}</p>
            <p class="text-green-100 text-sm">Email us anytime</p>
          </div>
        </a>

        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
            <svg class="w-6 h-6" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          </div>
          <div>
            <p class="font-bold text-lg">Mon&ndash;Sat 7am&ndash;7pm</p>
            <p class="text-green-100 text-sm">Sunday by appointment</p>
          </div>
        </div>
      </div>
    </div>
  </Container>
</section>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const successDiv = document.getElementById('contact-success');
  const errorDiv = document.getElementById('contact-error');
  if (form && successDiv && errorDiv) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = new FormData(form);
      // Honeypot check
      if (data.get('website')) return;

      const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      btn.disabled = true;
      btn.textContent = 'Sending...';
      errorDiv.classList.add('hidden');

      try {
        const res = await fetch('/api/contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: data.get('name'),
            phone: data.get('phone'),
            email: data.get('email'),
            postcode: data.get('postcode'),
            message: data.get('message'),
          }),
        });

        if (!res.ok) {
          throw new Error('Request failed');
        }

        const result = await res.json();
        if (!result.success) {
          throw new Error(result.message || 'Something went wrong');
        }

        form.classList.add('hidden');
        successDiv.classList.remove('hidden');
      } catch (err) {
        btn.disabled = false;
        btn.textContent = 'Get My Free Quote';
        errorDiv.textContent = 'Something went wrong. Please try again or call us directly.';
        errorDiv.classList.remove('hidden');
      }
    });
  }
</script>
